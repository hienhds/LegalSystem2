services:
  # ================= MYSQL =================
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: 231123
      MYSQL_DATABASE: legal_db
    ports:
      - "3336:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - legal-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================= REDIS =================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - legal-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================= MONGODB =================
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: 231123
    volumes:
      - mongodb_data:/data/db
    networks:
      - legal-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================= ZOOKEEPER =================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - legal-network
    # THÊM MỚI: Healthcheck để Kafka biết khi nào Zookeeper thực sự sẵn sàng
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================= KAFKA =================
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy # Đợi Zookeeper khỏe mạnh mới chạy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
    networks:
      - legal-network


  # ================= DISCOVERY SERVER =================
  discovery-server:
    build:
      context: ./discovery-server
    container_name: discovery-server
    ports:
      - "8761:8761"
    networks:
      - legal-network
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ================= USER SERVICE =================
  user-service:
    build:
      context: ./user-service
    container_name: user-service
    ports:
      - "8081:8081"
    environment:
      SPRING_APPLICATION_NAME: user-service

      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/legal_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 231123

      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"

      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379

      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/

      JWT_SECRET: tfcpDkRTBFSltRZhYBfgQmxEF612WEecB0XkiibKf3W+cwZXKDEz+KSjBpPuzbZxnD1HRLgOhtWVgISia6WPaQ==
      JWT_EXPIRATION_ACCESS: 900000
      JWT_EXPIRATION_REFRESH: 604800000

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    networks:
      - legal-network

  # ================= FILE SERVICE =================
  file-service:
    build:
      context: ./file-service
    container_name: file-service
    ports:
      - "8083:8083"
      - "9090:9090"
    environment:
      SPRING_APPLICATION_NAME: file-service
      SPRING_DATA_MONGODB_URI: mongodb://admin:231123@mongodb:27017/file_db?authSource=admin
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
      MINIO_URL: http://localhost:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET_DEFAULT: file-service
      MINIO_PRESIGNED_EXPIRY: 1000
    
    extra_hosts:
      - "localhost:host-gateway" 
      # - "minio-host:9000" 

      # MINIO_INTERNAL_ENDPOINT: http://minio:9000
      # MINIO_PUBLIC_ENDPOINT: http://localhost:9000
      # MINIO_SERVER_URL: http://localhost:9000

      # MINIO_ACCESS_KEY: minioadmin
      # MINIO_SECRET_KEY: minioadmin
      # MINIO_BUCKET_DEFAULT: file-service
      # MINIO_PRESIGNED_EXPIRY: 6000

    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_started
      minio:
        condition: service_started
      discovery-server:
        condition: service_healthy
    networks:
      - legal-network

  # ================= CHAT SERVICE =================
  chat-service:
    build:
      context: ./chat-service
    container_name: chat-service
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/chat_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 231123

      SPRING_DATA_MONGODB_URI: mongodb://admin:231123@mongodb:27017/chat_db?authSource=admin
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092

      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/

    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
      file-service:
        condition: service_started
      user-service:
        condition: service_started
      discovery-server:
        condition: service_healthy
    networks:
      - legal-network

  # ================= NOTIFICATION SERVICE =================
  notification-service:
    build:
      context: ./notification-service
    container_name: notification-service
    ports:
      - "8084:8084"
    environment:
      SPRING_APPLICATION_NAME: notification-service

      SPRING_DATA_MONGODB_URI: mongodb://admin:231123@mongodb:27017/notification_db?authSource=admin
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092

      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/

      JWT_SECRET: tfcpDkRTBFSltRZhYBfgQmxEF612WEecB0XkiibKf3W+cwZXKDEz+KSjBpPuzbZxnD1HRLgOhtWVgISia6WPaQ==

    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
      discovery-server:
        condition: service_healthy
    networks:
      - legal-network

  # ================= API GATEWAY =================
  api-gateway:
    build:
      context: ./api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
    depends_on:
      discovery-server:
        condition: service_healthy
      user-service:
        condition: service_started
      chat-service:
        condition: service_started
      notification-service:
        condition: service_started
      file-service:
        condition: service_started
    networks:
      - legal-network

  # ================= MINIO =================
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin

      MINIO_NOTIFY_KAFKA_ENABLE_primary: "on"
      MINIO_NOTIFY_KAFKA_BROKERS_primary: "kafka:29092"
      MINIO_NOTIFY_KAFKA_TOPIC_primary: "minio-events"

      # MINIO_NOTIFY_KAFKA_VERSION_primary: "7.5.0"
      # MINIO_SERVER_URL: http://localhost:9000
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - legal-network

networks:
  legal-network:

volumes:
  mysql_data:
  mongodb_data:
  minio_data:
